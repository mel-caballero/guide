<div id="card" class="card">
  <div class="card-header text-center">
    <h2>Contraste de color</h2>
  </div>
  <div class="card-body">
    <h3>Contenido textual</h3>
    <p>El texto normal (tamaño inferior a 18 puntos o a 14 puntos y negrita) y el texto normal en imágenes deben tener un contraste respecto al color de fondo de al menos 4.5:1.</p>
    <p>El texto grande (tamaño superior a 18 puntos o a 14 puntos y negrita) y el texto grande en imágenes deben tener un contraste respecto al color de fondo de al menos 3:1.</p>
    <p>Los enlaces no se deben diferenciar del texto que los rodea únicamente mediante el color o al menos tienen un contraste de 3:1 con el texto que los rodea y se deben emplear pistas visuales adicionales cuando reciben el foco.</p>
    <h3>Contenido no textual</h3>
    <p>Se debe asegurar un ratio mínimo de contraste de al menos 3:1 en los colores adyacentes de:</p>
    <ul>
      <li>Componentes de la interfaz de usuario: la información visual necesaria para identificar los componentes de la interfaz de usuario y los estados.</li>
      <li>Objetos gráficos: todas las partes de los gráficos que sean necesarias para comprender el contenido.</li>
    </ul>
    <h3>Calculadora de contraste</h3>
    <div class="row">
      <div class="col-4 px-3 row">
        <label for="texto" class="col-6 form-label">Color texto</label>
        <input type="color" class="col form-control form-control-color" id="texto" value="#003300">
      </div>
      <div class="col-4 px-3 row">
        <label for="fondo" class="col-6 form-label">Color fondo</label>
        <input type="color" class="col form-control form-control-color" id="fondo" value="#DEFECA">
      </div>
      <div id="muestra" class="col-4 text-center mx-4">
        <p class="my-1">Muestra</p>
      </div>
    </div>
    <div id="result"></div>
  </div>
</div>

<script>

  $(document).ready(startup(), updateMuestra(), checkContrast())

  function startup() {
    let texto;
    texto = document.querySelector("#texto");
    texto.addEventListener("input", updateMuestra, false);
    texto.addEventListener("change", updateMuestra, false);
    texto.select();

    let fondo;
    fondo = document.querySelector("#fondo");
    fondo.addEventListener("input", updateMuestra, false);
    fondo.addEventListener("change", updateMuestra, false);
    fondo.select();
  }

  function updateMuestra() {
    var texto = document.getElementById("texto").value;
    var fondo = document.getElementById("fondo").value;
    $('#muestra').css('background-color', fondo);
    $('#muestra p').css('color', texto);
    checkContrast();
  }

  function checkContrast() {

    var texto = document.getElementById("texto").value;
    var fondo = document.getElementById("fondo").value;
    const ratio = calculateRatio(texto, fondo);
    // show results depending on WCAG requirements
    const result = `
    AA-level large text: ${ratio < 1/3 ? 'PASS' : 'FAIL' }<br>
    AA-level small text: ${ratio < 1/4.5 ? 'PASS' : 'FAIL' }<br>
    AAA-level large text: ${ratio < 1/4.5 ? 'PASS' : 'FAIL' }<br>
    AAA-level small text: ${ratio < 1/7 ? 'PASS' : 'FAIL' }
    `;
    document.querySelector("#result").innerHTML = result;
  }


  // function from https://stackoverflow.com/a/5624139/3695983
  function hexToRgb(hex) {
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
      return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  // function from https://stackoverflow.com/a/9733420/3695983                     
  function luminance(r, g, b) {
    var a = [r, g, b].map(function (v) {
      v /= 255;
      return v <= 0.03928
        ? v / 12.92
      : Math.pow( (v + 0.055) / 1.055, 2.4 );
    });
    return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
  }

  function calculateRatio(color1, color2) {
    // read the colors and transform them into rgb format
    const color1rgb = hexToRgb(color1);
    const color2rgb = hexToRgb(color2);

    // calculate the relative luminance
    const color1luminance = luminance(color1rgb.r, color1rgb.g, color1rgb.b);
    const color2luminance = luminance(color2rgb.r, color2rgb.g, color2rgb.b);

    // calculate the color contrast ratio
    const ratio = color1luminance > color2luminance 
    ? ((color2luminance + 0.05) / (color1luminance + 0.05))
    : ((color1luminance + 0.05) / (color2luminance + 0.05));

    return ratio;
  }

  
</script>